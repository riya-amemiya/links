name: Update Actions

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Update actions
        run: |
          updated=false

          for file in .github/workflows/*.yml; do
            echo "Processing $file"

            grep "uses:" "$file" | awk '{print $3}' | while read -r action; do
              if [[ "$action" == *"@"* && "$action" != *"./"* ]]; then
                repo=$(echo "$action" | cut -d@ -f1)
                current_ref=$(echo "$action" | cut -d@ -f2)

                echo "Checking $repo (current: $current_ref)"

                latest_tag=$(gh release view --repo "$repo" --json tagName -q .tagName 2>/dev/null || continue)
                latest_hash=$(gh api "repos/$repo/git/ref/tags/$latest_tag" -q .object.sha 2>/dev/null || continue)

                if [ "$current_ref" != "$latest_hash" ]; then
                  echo "Updating $repo: $current_ref -> $latest_hash ($latest_tag)"
                  sed -i "s|$action.*|$repo@$latest_hash # $latest_tag|g" "$file"
                  updated=true
                fi
              fi
            done
          done

          if [ "$updated" = "true" ]; then
            git config user.name github-actions
            git config user.email github-actions@github.com
            git checkout -b "update-actions-$(date +%Y%m%d)"
            git add .github/workflows/
            git commit -m "chore: update GitHub Actions to latest releases"
            git push origin "update-actions-$(date +%Y%m%d)"
            gh pr create --title "chore: update GitHub Actions to latest releases" --body "Automated update to latest release versions" --base main
          else
            echo "All actions are up to date"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}