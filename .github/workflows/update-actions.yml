name: Update Actions

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Update actions
        run: |
          updated=false

          for file in .github/workflows/*.yml; do
            echo "Processing $file"

            grep "uses:" "$file" | awk '{print $3}' | while read -r action; do
              if [[ "$action" == *"@"* && "$action" != *"./"* ]]; then
                action_name=$(echo "$action" | cut -d@ -f1)
                repo_for_gh=$(echo "$action_name" | cut -d/ -f1,2)
                current_ref=$(echo "$action" | cut -d@ -f2)

                echo "Checking $action_name (repo: $repo_for_gh, current: $current_ref)"

                latest_tag=$(gh release view --repo "$repo_for_gh" --json tagName --template '{{.tagName}}' 2>/dev/null)
                if [ -z "$latest_tag" ]; then
                  echo "  -> Could not find latest release for $repo_for_gh. Skipping."
                  continue
                fi

                latest_hash=$(gh api "repos/$repo_for_gh/git/ref/tags/$latest_tag" --template '{{.object.sha}}' 2>/dev/null)
                if [ -z "$latest_hash" ]; then
                  echo "  -> Could not find commit hash for tag '$latest_tag' in $repo_for_gh. Skipping."
                  continue
                fi

                if [ "$current_ref" != "$latest_hash" ]; then
                  echo "Updating $action_name: $current_ref -> $latest_hash ($latest_tag)"
                  sed -i "s|$action.*|$action_name@$latest_hash # $latest_tag|g" "$file"
                  updated=true
                fi
              fi
            done
          done

          if [ "$updated" = "true" ]; then
            git config user.name github-actions
            git config user.email github-actions@github.com
            git checkout -b "update-actions-$(date +%Y%m%d)"
            git add .github/workflows/
            git commit -m "chore: update GitHub Actions to latest releases"
            git push origin "update-actions-$(date +%Y%m%d)"
            gh pr create --title "chore: update GitHub Actions to latest releases" --body "Automated update to latest release versions" --base main
          else
            echo "All actions are up to date"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}